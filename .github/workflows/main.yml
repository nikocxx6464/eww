name: Build AArch64 Debian Package

on:
  # Allows you to manually trigger the workflow from the GitHub Actions tab
  workflow_dispatch:
  # You can also trigger it on a tag push, e.g., 'v*'
  # push:
  #   tags:
  #     - 'v*'

jobs:
  build_arm64_deb:
    # Use the fast and readily available x86_64 runner (Ubuntu)
    runs-on: ubuntu-latest

    steps:
    - name: Checkout Repository
      uses: actions/checkout@v4
      
    # This step sets up QEMU for ARM64 emulation on the x86_64 runner
    - name: Set up QEMU for cross-compilation
      uses: docker/setup-qemu-action@v3
      with:
        platforms: all

    # This action sets up the Rust toolchain and the AArch64 target
    - name: Install Rust and AArch64 target
      uses: dtolnay/rust-toolchain@stable
      with:
        toolchain: stable
        # Add the target architecture for cross-compilation
        targets: aarch64-unknown-linux-gnu

    # Install cargo-deb, the tool that creates the .deb package
    - name: Install cargo-deb
      run: |
        # Use cargo install to get the debian packaging tool
        cargo install cargo-deb

    # Install the cross-compilation dependencies for the target architecture
    - name: Install AArch64 system dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y crossbuild-essential-arm64
        # Add the target architecture to dpkg
        sudo dpkg --add-architecture arm64
        # Install the dependencies eww needs for the arm64 architecture
        sudo apt-get install -y \
          libgtk-3-dev:arm64 \
          libgdk-pixbuf2.0-dev:arm64 \
          libcairo-dev:arm64 \
          libglib2.0-dev:arm64 \
          libpango1.0-dev:arm64 \
          libdbusmenu-gtk3-dev:arm64

    # Build the DEB package for the AArch64 architecture
    - name: Build .deb for AArch64
      run: |
        # Use cargo deb to build and package for the target architecture
        # --no-default-features is often used in minimal builds, but EWW needs its features.
        # --target is the key to cross-compilation
        cargo deb --target=aarch64-unknown-linux-gnu --output target/eww.deb

    # Upload the resulting package so you can download it
    - name: Upload AArch64 .deb artifact
      uses: actions/upload-artifact@v4
      with:
        name: eww-aarch64-deb
        path: target/eww.deb
